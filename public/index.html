<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>So8å£°å¡å‚æ•°ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #loading {
            text-align: center;
            margin: 20px 0;
            display: none;
            color: #007bff;
        }
        #error {
            color: red;
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        #audio-analysis {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        #result-area {
            margin-top: 30px;
            display: none;
        }
        .result-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .result-item h3 {
            margin-bottom: 8px;
            color: #333;
        }
        .tips {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>So8å£°å¡å‚æ•°ç”Ÿæˆå™¨</h1>
        
        <div class="form-group">
            <label for="mic-model">è¯ç­’å‹å·ï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" id="mic-model" placeholder="ä¾‹å¦‚ï¼šåŠ¨åœˆéº¦/ç”µå®¹éº¦/æ‰‹æŒéº¦/é¢†å¤¹éº¦">
        </div>
        
        <div class="form-group">
            <label for="phone-system">æ‰‹æœºç³»ç»Ÿï¼ˆå¿…å¡«ï¼‰</label>
            <select id="phone-system">
                <option value="android">å®‰å“</option>
                <option value="ios">iOS</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="usage">ä½¿ç”¨åœºæ™¯ï¼ˆå¿…å¡«ï¼‰</label>
            <select id="usage">
                <option value="sing-live">å”±æ­Œç›´æ’­</option>
                <option value="chat">èŠå¤©/ç”µå°</option>
                <option value="audio-book">æœ‰å£°ä¹¦/é…éŸ³</option>
                <option value="other">å…¶ä»–</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="song-style">æ­Œæ›²é£æ ¼ï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" id="song-style" placeholder="ä¾‹å¦‚ï¼šæµè¡Œ/å¤é£/è¯´å”±/æ°‘è°£/å¿«æ­Œ/æ…¢æ­Œ">
        </div>
        
        <div class="form-group">
            <label for="noise-level">ç¯å¢ƒå™ªéŸ³ï¼ˆå¿…å¡«ï¼‰</label>
            <select id="noise-level">
                <option value="quiet">å®‰é™ï¼ˆæ— æ‚éŸ³ï¼‰</option>
                <option value="slight">è½»å¾®ï¼ˆæœ‰ä¸€ç‚¹æ‚éŸ³ï¼‰</option>
                <option value="loud">å˜ˆæ‚ï¼ˆå™ªéŸ³æ˜æ˜¾ï¼‰</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="voice-type">å£°çº¿ç±»å‹</label>
            <select id="voice-type">
                <option value="normal">æ­£å¸¸</option>
                <option value="thin">åç»†/å°–</option>
                <option value="thick">åç²—/é—·</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="voice-problem">äººå£°é—®é¢˜</label>
            <input type="text" id="voice-problem" placeholder="ä¾‹å¦‚ï¼šæœ‰é¼»éŸ³/å°å£°å”±æ­Œæ˜“æ–­éŸ³/å£°éŸ³åˆºè€³/å‘é—·">
        </div>
        
        <div class="form-group">
            <label for="audio-file">ä¸Šä¼ éŸ³é¢‘ï¼ˆå¯é€‰ï¼Œ30-60ç§’MP3/WAVï¼‰</label>
            <input type="file" id="audio-file" accept=".mp3,.wav">
            <p class="tips">éŸ³é¢‘è¦æ±‚ï¼šâ‰¤5MBï¼Œå‰10ç§’å½•ç¯å¢ƒå™ªéŸ³ï¼Œä¸­é—´20ç§’æ­£å¸¸è¯´è¯ï¼Œæœ€å10ç§’å”±1å¥æ­Œæ›²ç‰‡æ®µ</p>
        </div>
        
        <button id="generate-btn">ç”Ÿæˆå‚æ•°</button>
        
        <div id="loading">åŠ è½½ä¸­...æ­£åœ¨åˆ†æéŸ³é¢‘å’Œç”Ÿæˆå‚æ•°</div>
        <div id="error"></div>
        <div id="audio-analysis"></div>
        
        <div id="result-area">
            <div class="result-item">
                <h3>åŸºç¡€æ—‹é’®å‚æ•°</h3>
                <p id="basic-knobs"></p>
            </div>
            <div class="result-item">
                <h3>é™å™ªé˜ˆå€¼</h3>
                <p id="noise-reduction"></p>
            </div>
            <div class="result-item">
                <h3>å‡è¡¡å™¨å‚æ•°</h3>
                <p id="eq-params"></p>
            </div>
            <div class="result-item">
                <h3>å‹ç¼©å™¨å‚æ•°</h3>
                <p id="compressor-params"></p>
            </div>
            <div class="result-item">
                <h3>æ··å“å‚æ•°</h3>
                <p id="reverb-params"></p>
            </div>
            <div class="result-item">
                <h3>ä¼˜åŒ–å»ºè®®</h3>
                <p id="optimize-tips"></p>
            </div>
        </div>
    </div>

    <script>
        // å‰ç«¯éŸ³é¢‘ç‰¹å¾æå–ï¼ˆWeb Audio APIï¼‰
        async function extractAudioFeatures(audioFile) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await audioFile.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // è·å–å•å£°é“æ•°æ®
                const channelData = audioBuffer.getChannelData(0);
                const sampleRate = audioBuffer.sampleRate;
                const duration = audioBuffer.duration;

                // 1. å™ªéŸ³æ®µï¼ˆå‰10ç§’ï¼‰
                const noiseFrames = Math.min(Math.floor(10 * sampleRate), channelData.length);
                const noiseData = channelData.slice(0, noiseFrames);
                const noiseEnergy = noiseData.reduce((sum, val) => sum + Math.abs(val), 0) / (noiseFrames || 1);

                // 2. äººå£°æ®µï¼ˆ10ç§’åï¼‰
                const voiceStart = Math.max(Math.floor(10 * sampleRate), 0);
                const voiceEnd = Math.min(Math.floor(60 * sampleRate), channelData.length);
                const voiceData = voiceEnd > voiceStart ? channelData.slice(voiceStart, voiceEnd) : channelData;
                
                // éŸ³é‡è®¡ç®—ï¼ˆRMSï¼‰
                const voiceRms = Math.sqrt(voiceData.reduce((sum, val) => sum + val * val, 0) / (voiceData.length || 1));
                const voiceAvgVolume = 20 * Math.log10(voiceRms + 1e-8);
                const voicePeak = Math.max(...voiceData.map(Math.abs));
                const voicePeakVolume = 20 * Math.log10(voicePeak + 1e-8);
                const voiceMin = Math.min(...voiceData.filter(val => val > 0).map(Math.abs));
                const voiceMinVolume = 20 * Math.log10((voiceMin || 1e-8) + 1e-8);
                const voiceDynamicRange = voicePeakVolume - voiceMinVolume;

                // é«˜é¢‘èƒ½é‡ï¼ˆé‡‡æ ·ç‚¹å˜åŒ–ç‡ï¼‰
                let highFreqEnergy = 0;
                if (voiceData.length > 1) {
                    let diffSum = 0;
                    for (let i = 1; i < voiceData.length; i++) {
                        diffSum += Math.abs(voiceData[i] - voiceData[i-1]);
                    }
                    highFreqEnergy = diffSum / (voiceData.length - 1);
                }

                return {
                    duration: duration.toFixed(1),
                    noiseEnergy: (noiseEnergy * 100).toFixed(2),
                    voiceAvgVolume: voiceAvgVolume.toFixed(1),
                    voicePeakVolume: voicePeakVolume.toFixed(1),
                    voiceDynamicRange: voiceDynamicRange.toFixed(1),
                    highFreqEnergy: (highFreqEnergy * 100).toFixed(2),
                    success: true
                };
            } catch (e) {
                return {
                    success: false,
                    error: `éŸ³é¢‘è§£æå¤±è´¥ï¼š${e.message}`
                };
            }
        }

        // å‚æ•°ç”Ÿæˆæ ¸å¿ƒé€»è¾‘
        function generateSo8Params(formData, audioFeatures = null) {
            const params = {
                basicKnobs: "",
                noiseReduction: "-70db",
                eqParams: "",
                compressorParams: "",
                reverbParams: "",
                optimizeTips: ""
            };

            // 1. åŸºç¡€æ—‹é’®
            let micVolume = 24;
            let recordVolume = 25;
            if (formData.micModel.includes("åŠ¨åœˆ")) micVolume = 26;
            else if (formData.micModel.includes("ç”µå®¹")) micVolume = 22;
            if (formData.usage === "sing-live") recordVolume = 24;
            
            // éŸ³é¢‘é€‚é…
            if (audioFeatures?.success) {
                if (parseFloat(audioFeatures.voicePeakVolume) > -10) recordVolume = Math.max(20, recordVolume - 3);
                else if (parseFloat(audioFeatures.voicePeakVolume) < -25) recordVolume = Math.min(28, recordVolume + 2);
            }
            params.basicKnobs = `è¯ç­’éŸ³é‡ï¼š${micVolume} | è€³æœºéŸ³é‡ï¼š25 | ä¼´å¥éŸ³é‡ï¼š23 | å½•éŸ³éŸ³é‡ï¼š${recordVolume} | éŸ³æ•ˆéŸ³é‡ï¼š18`;

            // 2. é™å™ªé˜ˆå€¼
            if (audioFeatures?.success) {
                if (parseFloat(audioFeatures.noiseEnergy) > 0.1) params.noiseReduction = "-60db";
                else if (parseFloat(audioFeatures.noiseEnergy) < 0.02) params.noiseReduction = "-82db";
            } else {
                switch (formData.noiseLevel) {
                    case "quiet": params.noiseReduction = "-80db"; break;
                    case "slight": params.noiseReduction = "-75db"; break;
                    case "loud": params.noiseReduction = "-65db"; break;
                }
            }
            if (formData.voiceProblem.includes("å°å£°å”±æ­Œæ˜“æ–­éŸ³")) {
                const val = parseInt(params.noiseReduction);
                params.noiseReduction = `${val - 8}db`;
            }

            // 3. å‡è¡¡å™¨
            let eqBase = "qå€¼ç»Ÿä¸€4.5 | é«˜é€š12æ¡£(40hz) | ä½é€š12æ¡£(12000hz) | ";
            let eqCustom = "";
            if (audioFeatures?.success) {
                if (parseFloat(audioFeatures.highFreqEnergy) > 0.1) eqCustom += "5350hzå¢ç›Š-2.5 | 9500hzå¢ç›Š-2 | ";
                else if (parseFloat(audioFeatures.highFreqEnergy) < 0.02) eqCustom += "5350hzå¢ç›Š+3 | 9500hzå¢ç›Š+2.5 | ";
            }
            if (formData.voiceProblem.includes("æœ‰é¼»éŸ³")) eqCustom += "1350hzå¢ç›Š-2.5 | ";
            if (formData.voiceType === "thin") eqCustom += "100hzå¢ç›Š+3.5 | 450hzå¢ç›Š+2.5 | ";
            if (formData.voiceType === "thick") eqCustom += "100hzå¢ç›Š-1.5 | 280hzå¢ç›Š-1.5 | ";
            params.eqParams = eqBase + eqCustom + "100hzå¢ç›Š+2 | 140hzå¢ç›Š-1 | 280hzå¢ç›Š0 | 450hzå¢ç›Š+1.5 | 850hzå¢ç›Š-0.5 | 2800hzå¢ç›Š+1 | 10000hzå¢ç›Š+1.5";

            // 4. å‹ç¼©å™¨
            let compressorBase = "å‹ç¼©æ¯”4:1 | ";
            let threshold = "-15dbï¼ˆå°å—“é—¨ï¼‰";
            let attackTime = 440;
            let releaseTime = 1700;
            let gainCompensation = 2;
            
            if (audioFeatures?.success) {
                if (parseFloat(audioFeatures.voiceAvgVolume) > -15) threshold = "-25dbï¼ˆå¤§å—“é—¨ï¼‰";
                else if (parseFloat(audioFeatures.voiceAvgVolume) < -25) threshold = "-12dbï¼ˆå°å—“é—¨ï¼‰";
                if (parseFloat(audioFeatures.voiceDynamicRange) > 20) releaseTime = 1800;
                gainCompensation = parseFloat(audioFeatures.voiceAvgVolume) < -20 ? 3 : 2;
            }
            if (formData.songStyle.includes("å¿«æ­Œ") || formData.songStyle.includes("rap")) {
                attackTime = 800;
                releaseTime = 1500;
            }
            params.compressorParams = `${compressorBase}é˜ˆå€¼ï¼š${threshold} | å¼€å§‹æ—¶é—´ï¼š${attackTime} | é‡Šæ”¾æ—¶é—´ï¼š${releaseTime} | å¢ç›Šè¡¥å¿ï¼š+${gainCompensation}`;

            // 5. æ··å“
            let dryWet = 82;
            let reverbVol = 22;
            if (audioFeatures?.success && parseFloat(audioFeatures.voiceAvgVolume) < -20) {
                dryWet = 78;
                reverbVol = 18;
            }
            switch (formData.usage) {
                case "sing-live": params.reverbParams = `å¹²æ¹¿æ¯”${dryWet}% | æ··å“éŸ³é‡${reverbVol} | é¢„å»¶è¿Ÿ18ms | æ··å“æ—¶é—´4600ms`; break;
                case "chat": params.reverbParams = `å¹²æ¹¿æ¯”${dryWet - 10}% | æ··å“éŸ³é‡${reverbVol - 7} | é¢„å»¶è¿Ÿ15ms | æ··å“æ—¶é—´3000ms`; break;
                case "audio-book": params.reverbParams = `å¹²æ¹¿æ¯”${dryWet - 20}% | æ··å“éŸ³é‡${reverbVol - 12} | é¢„å»¶è¿Ÿ10ms | æ··å“æ—¶é—´2000ms`; break;
                default: params.reverbParams = `å¹²æ¹¿æ¯”${dryWet - 2}% | æ··å“éŸ³é‡${reverbVol - 2} | é¢„å»¶è¿Ÿ20ms | æ··å“æ—¶é—´4000ms`;
            }

            // 6. ä¼˜åŒ–å»ºè®®
            const tips = [];
            if (audioFeatures?.success) {
                if (parseFloat(audioFeatures.voicePeakVolume) > -5) tips.push("1. äººå£°å³°å€¼éŸ³é‡è¾ƒé«˜ï¼Œå»ºè®®å½•éŸ³éŸ³é‡å†é™ä½2-3ï¼Œé¿å…çˆ†éŸ³ï¼›");
                else if (parseFloat(audioFeatures.voiceAvgVolume) < -30) tips.push("1. äººå£°å¹³å‡éŸ³é‡è¾ƒä½ï¼Œå»ºè®®è¯ç­’éŸ³é‡æé«˜2-3ï¼Œå‹ç¼©å¢ç›Šè¡¥å¿+4ï¼›");
                if (parseFloat(audioFeatures.noiseEnergy) > 0.15) tips.push("2. å™ªéŸ³èƒ½é‡è¾ƒé«˜ï¼Œå»ºè®®å¢åŠ å¸éŸ³æ£‰/å…³é—­é—¨çª—ï¼Œé™å™ªé˜ˆå€¼å¯å¾®è°ƒè‡³-55dbï¼›");
                if (parseFloat(audioFeatures.highFreqEnergy) > 0.1) tips.push("3. äººå£°é«˜é¢‘è¿‡å¼ºï¼Œè‹¥ä»åˆºè€³å¯å°†5350hzå¢ç›Šå†å‡1ï¼›");
                else if (parseFloat(audioFeatures.highFreqEnergy) < 0.02) tips.push("3. äººå£°é«˜é¢‘ä¸è¶³ï¼Œè‹¥å£°éŸ³å‘é—·å¯å°†9500hzå¢ç›Šå†+1ï¼›");
            }
            if (tips.length === 0) tips.push("1. è‹¥å”±æ­Œçˆ†éŸ³ï¼Œå¯å°†å½•éŸ³éŸ³é‡å†é™ä½1-2ï¼›2. è‹¥æ··å“ç›–è¿‡äººå£°ï¼Œå¯é™ä½æ··å“éŸ³é‡æˆ–å¹²æ¹¿æ¯”ï¼›");
            if (formData.voiceProblem.includes("é¼»éŸ³")) tips.push("4. è‹¥é¼»éŸ³ä»æ˜æ˜¾ï¼Œå¯å°†1350hzå¢ç›Šå†å‡1ï¼›");
            params.optimizeTips = tips.join("");

            return params;
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('generate-btn').addEventListener('click', async function() {
            // é‡ç½®çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('audio-analysis').style.display = 'none';
            document.getElementById('result-area').style.display = 'none';

            // è¡¨å•éªŒè¯
            const micModel = document.getElementById('mic-model').value.trim();
            const songStyle = document.getElementById('song-style').value.trim();
            if (!micModel) {
                document.getElementById('error').textContent = "è¯·å¡«å†™è¯ç­’å‹å·ï¼";
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }
            if (!songStyle) {
                document.getElementById('error').textContent = "è¯·å¡«å†™æ­Œæ›²é£æ ¼ï¼";
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = {
                micModel: micModel,
                phoneSystem: document.getElementById('phone-system').value,
                usage: document.getElementById('usage').value,
                songStyle: songStyle,
                noiseLevel: document.getElementById('noise-level').value,
                voiceType: document.getElementById('voice-type').value,
                voiceProblem: document.getElementById('voice-problem').value.trim()
            };

            // å¤„ç†éŸ³é¢‘æ–‡ä»¶
            let audioFeatures = null;
            const audioFile = document.getElementById('audio-file').files[0];
            if (audioFile) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (audioFile.size > 5 * 1024 * 1024) {
                    document.getElementById('error').textContent = "éŸ³é¢‘æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼Œè¯·å‹ç¼©åä¸Šä¼ ï¼";
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    return;
                }
                // è§£æéŸ³é¢‘
                try {
                    audioFeatures = await extractAudioFeatures(audioFile);
                    if (audioFeatures.success) {
                        // æ˜¾ç¤ºéŸ³é¢‘åˆ†æç»“æœ
                        document.getElementById('audio-analysis').innerHTML = `
                            ğŸµ éŸ³é¢‘æ·±åº¦è§£æç»“æœï¼š<br>
                            - éŸ³é¢‘æ—¶é•¿ï¼š${audioFeatures.duration}ç§’<br>
                            - å™ªéŸ³èƒ½é‡ï¼š${audioFeatures.noiseEnergy}%ï¼ˆå€¼è¶Šé«˜å™ªéŸ³è¶Šå¤§ï¼‰<br>
                            - äººå£°å¹³å‡éŸ³é‡ï¼š${audioFeatures.voiceAvgVolume}dB<br>
                            - äººå£°å³°å€¼éŸ³é‡ï¼š${audioFeatures.voicePeakVolume}dB<br>
                            - äººå£°åŠ¨æ€èŒƒå›´ï¼š${audioFeatures.voiceDynamicRange}dB<br>
                            - äººå£°é«˜é¢‘èƒ½é‡ï¼š${audioFeatures.highFreqEnergy}%ï¼ˆç›¸å¯¹å€¼ï¼‰
                        `;
                        document.getElementById('audio-analysis').style.display = 'block';
                    } else {
                        document.getElementById('error').textContent = audioFeatures.error;
                        document.getElementById('error').style.display = 'block';
                    }
                } catch (e) {
                    document.getElementById('error').textContent = `éŸ³é¢‘è§£æå¤±è´¥ï¼š${e.message}`;
                    document.getElementById('error').style.display = 'block';
                }
            }

            // ç”Ÿæˆå‚æ•°
            const params = generateSo8Params(formData, audioFeatures);

            // æ¸²æŸ“ç»“æœ
            document.getElementById('basic-knobs').textContent = params.basicKnobs;
            document.getElementById('noise-reduction').textContent = params.noiseReduction;
            document.getElementById('eq-params').textContent = params.eqParams;
            document.getElementById('compressor-params').textContent = params.compressorParams;
            document.getElementById('reverb-params').textContent = params.reverbParams;
            document.getElementById('optimize-tips').textContent = params.optimizeTips;

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        });
    </script>
</body>
</html>
